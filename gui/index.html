<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGRO — Local Configuration GUI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            line-height: 1.6;
        }

        .topbar {
            background: #111111;
            border-bottom: 1px solid #2a2a2a;
            padding: 14px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 56px;
        }

        .topbar h1 {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .topbar .brand {
            font-weight: 700;
            color: #00ff88;
        }

        .top-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .top-actions button {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            transition: all 0.2s;
        }

        .top-actions button:hover {
            background: #00dd77;
        }

        #health-status {
            color: #999;
            font-size: 13px;
            font-family: 'SF Mono', monospace;
            min-width: 60px;
        }

        #global-search {
            width: 280px;
            height: 34px;
            background: #0c0c0c;
            color: #ddd;
            border: 1px solid #2a2a2a;
            padding: 0 12px;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        #global-search:focus {
            outline: none;
            border-color: #00ff88;
            background: #111;
        }

        #global-search::placeholder {
            color: #666;
            font-size: 13px;
        }

        #search-results {
            position: absolute;
            top: 42px;
            right: 80px;
            width: 320px;
            max-height: 280px;
            overflow: auto;
            background: #0e0e0e;
            border: 1px solid #333;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
        }

        #search-results .item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #1a1a1a;
            color: #bbb;
            font-size: 13px;
            transition: all 0.1s;
        }

        #search-results .item:last-child {
            border-bottom: none;
        }

        #search-results .item:hover,
        #search-results .item.active {
            background: #1a1a1a;
            color: #fff;
        }

        mark.hl {
            background: #00ff88;
            color: #000;
            padding: 1px 3px;
            border-radius: 2px;
        }

        .search-hit {
            outline: 2px solid #00ff88;
            outline-offset: 2px;
            border-radius: 4px;
            transition: outline 120ms ease;
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            height: calc(100vh - 65px);
        }

        .content {
            display: flex;
            flex-direction: column;
            border-right: 1px solid #2a2a2a;
            overflow: hidden;
        }

        .tab-bar {
            background: #111111;
            padding: 10px 16px;
            border-bottom: 1px solid #2a2a2a;
            display: flex;
            gap: 6px;
            overflow-x: auto;
        }

        .tab-bar::-webkit-scrollbar {
            height: 4px;
        }

        .tab-bar::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 2px;
        }

        .tab-bar button {
            background: #1a1a1a;
            color: #999;
            border: 1px solid #2a2a2a;
            padding: 9px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .tab-bar button:hover {
            background: #222;
            color: #fff;
            border-color: #333;
        }

        .tab-bar button.active {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .tab-content.active {
            display: block;
        }

        #calc-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: #0a0a0a;
        }

        .settings-section {
            background: #111111;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #2a2a2a;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-section h3 span {
            font-size: 10px;
        }

        .settings-section p.small {
            margin-bottom: 14px;
            line-height: 1.5;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            min-width: 0; /* prevent grid overflow in narrow sidepanel */
        }

        .input-group.full-width {
            grid-column: span 2;
        }

        label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-bottom: 7px;
            font-weight: 500;
        }

        input, select, textarea {
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            padding: 9px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'SF Mono', 'Monaco', monospace;
            transition: all 0.2s;
        }

        input[type="number"], input[type="text"]:not([list]) {
            max-width: 100%;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #00ff88;
            background: #1f1f1f;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-size: 13px;
            line-height: 1.5;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .action-buttons button {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 11px 22px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.15s;
            box-shadow: 0 2px 8px rgba(0, 255, 136, 0.2);
        }

        .action-buttons button:hover {
            background: #00dd77;
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
            transform: translateY(-1px);
        }

        .action-buttons button:active {
            transform: translateY(0);
        }

        .sidepanel {
            background: #0a0a0a;
            padding: 20px;
            overflow-y: auto;
        }

        /* Ensure sidepanel two-column rows never overflow */
        .sidepanel .input-row { grid-template-columns: 1fr 1fr; }
        .sidepanel .input-group input,
        .sidepanel .input-group select,
        .sidepanel .input-group textarea { width: 100%; min-width: 0; }

        .sidepanel-section {
            background: #111111;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .sidepanel-section h4 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 14px;
            color: #00ff88;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sidepanel-section h4::before {
            content: '▸';
            font-size: 12px;
            color: #666;
        }

        .cost-results {
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            padding: 12px;
            margin-top: 12px;
        }

        .cost-results .result-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #1a1a1a;
        }

        .cost-results .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .result-value {
            font-size: 14px;
            color: #00ff88;
            font-weight: 600;
            font-family: 'SF Mono', monospace;
        }

        .progress {
            position: relative;
            overflow: hidden;
        }

        .progress div {
            box-shadow: 0 0 10px rgba(255, 155, 94, 0.3);
        }

        .dropzone {
            border: 2px dashed #00ff88;
            padding: 24px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            color: #999;
            line-height: 1.6;
        }

        .dropzone:hover {
            background: #0f0f0f;
            color: #00ff88;
            border-color: #00dd77;
        }

        .dropzone:active {
            background: #111;
        }

        .mono {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 13px;
            color: #aaa;
            line-height: 1.5;
        }

        .result-display {
            background: #0f0f0f;
            border: 1px solid #2a2a2a;
            border-radius: 6px;
            padding: 14px;
            margin-top: 12px;
            font-family: 'SF Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: #ddd;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: none;
        }

        .result-display .key {
            color: #7db3ff;
            font-weight: 600;
        }

        .result-display .value {
            color: #fff;
        }

        .result-display .section {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #1a1a1a;
        }

        .result-display .section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .small-button {
            background: #1a1a1a;
            color: #00ff88;
            border: 1px solid #00ff88;
            padding: 7px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            transition: all 0.2s;
            width: 100%;
            margin-top: 8px;
        }

        .small-button:hover {
            background: #00ff88;
            color: #000;
        }

        .dash-two {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        /* Color accents for different types of info */
        .accent-blue { color: #5b9dff; }
        .accent-purple { color: #b794f6; }
        .accent-orange { color: #ff9b5e; }
        .accent-cyan { color: #4ecdc4; }
        .accent-pink { color: #ff7eb6; }

        .settings-section.wizard {
            border-left: 3px solid #5b9dff;
        }

        .settings-section.cost {
            border-left: 3px solid #b794f6;
        }

        .settings-section.indexing {
            border-left: 3px solid #ff9b5e;
        }

        .settings-section.overview {
            border-left: 3px solid #4ecdc4;
        }

        /* Live indicator animation */
        @keyframes blink {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 6px #00ff88;
            }
            50% {
                opacity: 0.3;
                box-shadow: 0 0 0 #00ff88;
            }
        }

        @media (max-width: 1200px) {
            .layout {
                grid-template-columns: 1fr;
            }
            .sidepanel {
                border-top: 1px solid #2a2a2a;
            }
            .dash-two {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="topbar">
        <h1><span class="brand">AGRO</span> Configuration GUI</h1>
        <div class="top-actions">
            <input id="global-search" type="search" placeholder="Search settings (Ctrl+K)">
            <div id="search-results"></div>
            <button id="btn-health">Health</button>
            <span id="health-status">—</span>
        </div>
    </div>

    <div class="layout">
        <div class="content">
            <div class="tab-bar">
                <button class="active" data-tab="dashboard">Dashboard</button>
                <button data-tab="models">Models</button>
                <button data-tab="retrieval">Retrieval</button>
                <button data-tab="repos">Repos & Indexing</button>
                <button data-tab="infra">Infrastructure</button>
                <button data-tab="tools">Tools</button>
            </div>

            <!-- Tab: Dashboard -->
            <div id="tab-dashboard" class="tab-content active">
                <div class="settings-section overview">
                    <h3><span class="accent-cyan">●</span> Overview</h3>
                    <p class="small">Quick health and repo status. "Cards" are high‑level summaries the retriever uses to boost relevant files (see Cards tab).</p>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Health</label>
                            <div id="dash-health" class="mono">—</div>
                        </div>
                        <div class="input-group">
                            <label>Current Repo</label>
                            <div id="dash-repo" class="mono">—</div>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Autotune</label>
                            <div id="dash-autotune" class="mono">—</div>
                        </div>
                        <div class="input-group">
                            <label>Cards</label>
                            <div id="dash-cards" class="mono">—</div>
                        </div>
                        <div class="input-group">
                            <label>MCP HTTP</label>
                            <div id="dash-mcp" class="mono">—</div>
                        </div>
                    </div>
                </div>

                <div class="settings-section indexing">
                    <h3><span class="accent-orange">●</span> Quick Actions</h3>
                    <p class="small">Run the indexer (BM25 + vectors) and build "cards" (high‑level hints used to improve retrieval ranking).</p>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Indexer</label>
                            <div style="display:flex; gap:8px;">
                                <button class="small-button" id="dash-index-start">Run Indexer</button>
                                <button class="small-button" id="dash-cards-build">Build Cards</button>
                                <button class="small-button" id="dash-cards-refresh">Refresh</button>
                            </div>
                        </div>
                    </div>
                    <div id="dash-index-status" class="result-display" style="min-height: 60px;"></div>
                    <div class="progress" style="margin-top:12px; background:#111; border:1px solid #2a2a2a; border-radius:4px; height:12px;">
                        <div id="dash-index-bar" style="height:100%; width:0%; background:#ff9b5e; transition: width 0.3s ease;"></div>
                    </div>
                </div>

                <div class="dash-two">
                <div class="settings-section wizard">
                    <h3><span class="accent-blue">●</span> Auto-Profile</h3>
                    <p class="small" style="margin-bottom:20px; color:#aaa; line-height: 1.6; font-size: 14px;">
                        The only platform where you can mix any provider, model, and database.
                        We analyze your hardware and budget to configure the optimal RAG automatically.
                    </p>

                    <div class="input-row" style="margin-bottom: 20px;">
                        <div class="input-group">
                            <label>Monthly Budget ($)</label>
                            <input type="number" id="budget" value="0" min="0" placeholder="0" style="font-size:16px;padding:12px;">
                        </div>
                        <div class="input-group">
                            <label style="opacity:0;">Action</label>
                            <button class="small-button" id="btn-wizard-oneclick" style="background:#00ff88;color:#000;border:none;width:100%;padding:12px 20px;font-size:14px;font-weight:700;">Configure Automatically</button>
                        </div>
                    </div>

                    <div id="scan-out" class="result-display" style="display:none;"></div>

                    <div style="margin-top:20px;background:#0a0a0a;border:1px solid #2a2a2a;border-radius:8px;padding:16px;">
                        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                            <span style="font-size:13px;color:#aaa;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;">Recommended Options</span>
                            <span style="font-size:11px;color:#666;">(auto-ranked by cost & performance)</span>
                        </div>
                        <pre id="tri-out" class="mono" style="background:#000;border:1px solid #1a1a1a;border-radius:6px;padding:12px;margin:0;font-size:13px;line-height:1.8;color:#bbb;max-height:180px;overflow:auto;">(Press button above to generate)</pre>
                    </div>

                    <div id="profile-preview" class="result-display" style="display:none;margin-top:16px;"></div>
                </div>
                </div>
            </div>

            <!-- Tab: Storage Calculator -->
            <div id="tab-calculator" class="tab-content">
                <iframe id="calc-frame" src="/gui/rag-calculator.html"></iframe>
            </div>
            <div id="tab-tools" class="tab-content">
                <div class="settings-section">
                    <h3>MCP & Channels</h3>
                    <p class="small">Set per‑channel inference models. Provider is inferred from the model name; use base URL and keys from Infrastructure or Models for proxies/local engines.</p>
                    <div class="input-row">
                        <div class="input-group">
                            <label>HTTP Responses Model</label>
                            <input type="text" name="GEN_MODEL_HTTP" placeholder="override HTTP model">
                        </div>
                        <div class="input-group">
                            <label>MCP stdio Model</label>
                            <input type="text" name="GEN_MODEL_MCP" placeholder="override MCP model">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>CLI Chat Model</label>
                            <input type="text" name="GEN_MODEL_CLI" placeholder="override CLI model">
                        </div>
                        <div class="input-group">
                            <label>MCP HTTP (host/port/path)</label>
                            <div style="display:flex; gap:8px;">
                                <input type="text" name="MCP_HTTP_HOST" placeholder="0.0.0.0" style="width:40%">
                                <input type="number" name="MCP_HTTP_PORT" placeholder="8013" style="width:30%">
                                <input type="text" name="MCP_HTTP_PATH" placeholder="/mcp" style="width:30%">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Generation -->
            <div id="tab-generation" class="tab-content">
                <div class="settings-section">
                    <h3>Generation Models</h3>
                    <button class="small-button" id="btn-add-gen-model" style="margin-bottom:12px;">Add Model</button>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Primary Model (GEN_MODEL)</label>
                            <input type="text" name="GEN_MODEL" placeholder="gpt-4o-mini or qwen3-coder:30b" list="gen-model-list">
                            <datalist id="gen-model-list"></datalist>
                        </div>
                        <div class="input-group">
                            <label>OpenAI API Key</label>
                            <input type="password" name="OPENAI_API_KEY">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Enrich Model (ENRICH_MODEL)</label>
                            <input type="text" name="ENRICH_MODEL" placeholder="gpt-4o-mini">
                        </div>
                        <div class="input-group">
                            <label>Enrich Model (Ollama)</label>
                            <input type="text" name="ENRICH_MODEL_OLLAMA" placeholder="qwen3-coder:30b">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Anthropic API Key</label>
                            <input type="password" name="ANTHROPIC_API_KEY">
                        </div>
                        <div class="input-group">
                            <label>Google API Key</label>
                            <input type="password" name="GOOGLE_API_KEY">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Ollama URL</label>
                            <input type="text" name="OLLAMA_URL" placeholder="http://127.0.0.1:11434">
                        </div>
                        <div class="input-group">
                            <label>OpenAI Base URL (optional)</label>
                            <input type="text" name="OPENAI_BASE_URL" placeholder="For vLLM proxy">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>HTTP Override Model</label>
                            <input type="text" name="GEN_MODEL_HTTP">
                        </div>
                        <div class="input-group">
                            <label>MCP Override Model</label>
                            <input type="text" name="GEN_MODEL_MCP">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>CLI Override Model</label>
                            <input type="text" name="GEN_MODEL_CLI">
                        </div>
                        <div class="input-group">
                            <label>Enrich Backend</label>
                            <select name="ENRICH_BACKEND">
                                <option value="">Default</option>
                                <option value="mlx">MLX (Apple)</option>
                                <option value="ollama">Ollama</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Embeddings -->
            <div id="tab-embeddings" class="tab-content">
                <div class="settings-section">
                    <h3>Embedding Configuration</h3>
                    <p class="small">Embeddings map text to vectors for dense retrieval. Choose a provider/model and dimensions where relevant.</p>
                    <button class="small-button" id="btn-add-embed-model" style="margin-bottom:12px;">Add Embedding Model</button>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Embedding Provider</label>
                            <select name="EMBEDDING_TYPE">
                                <option value="openai">OpenAI</option>
                                <option value="local">Local</option>
                                <option value="voyage">Voyage</option>
                                <option value="mxbai">MXBAI</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Voyage API Key</label>
                            <input type="password" name="VOYAGE_API_KEY">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Voyage Embed Dimension</label>
                            <input type="number" name="VOYAGE_EMBED_DIM" value="512">
                        </div>
                        <div class="input-group">
                            <label>MXBAI Dimension</label>
                            <input type="number" name="EMBEDDING_DIM" value="512">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Skip Dense Indexing</label>
                            <select name="SKIP_DENSE">
                                <option value="0">No</option>
                                <option value="1">Yes</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Enrich Code Chunks</label>
                            <select name="ENRICH_CODE_CHUNKS">
                                <option value="false">No</option>
                                <option value="true">Yes</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Reranking -->
            <div id="tab-reranking" class="tab-content">
                <div class="settings-section">
                    <h3>Reranking Configuration</h3>
                    <p class="small">Reranking reorders retrieved chunks by relevance using a cross‑encoder (Cohere/local/HF). Improves precision/confidence.</p>
                    <button class="small-button" id="btn-add-rerank-model" style="margin-bottom:12px;">Add Rerank Model</button>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Rerank Backend</label>
                            <select name="RERANK_BACKEND">
                                <option value="local">Local</option>
                                <option value="cohere">Cohere</option>
                                <option value="hf">Hugging Face</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Local Reranker Model</label>
                            <input type="text" name="RERANKER_MODEL" placeholder="BAAI/bge-reranker-v2-m3" list="rerank-model-list">
                            <datalist id="rerank-model-list"></datalist>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Cohere API Key</label>
                            <input type="password" name="COHERE_API_KEY">
                        </div>
                        <div class="input-group">
                            <label>Cohere Rerank Model</label>
                            <input type="text" name="COHERE_RERANK_MODEL" placeholder="rerank-3.5">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>HF Trust Remote Code</label>
                            <select name="TRANSFORMERS_TRUST_REMOTE_CODE">
                                <option value="1">On</option>
                                <option value="0">Off</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Retrieval -->
            <div id="tab-retrieval" class="tab-content">
                <div class="settings-section">
                    <h3>Retrieval Parameters</h3>
                    <p class="small">Hybrid search fuses sparse (BM25) + dense (vectors). These knobs tune candidate counts and hydration behavior.</p>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Multi-Query Rewrites</label>
                            <input type="number" name="MQ_REWRITES" value="2" min="1">
                        </div>
                        <div class="input-group">
                            <label>Final K</label>
                            <input type="number" name="FINAL_K" value="10" min="1">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Top-K Dense (Qdrant)</label>
                            <input type="number" name="TOPK_DENSE" value="75" min="1">
                        </div>
                        <div class="input-group">
                            <label>Top-K Sparse (BM25)</label>
                            <input type="number" name="TOPK_SPARSE" value="75" min="1">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Hydration Mode</label>
                            <select name="HYDRATION_MODE">
                                <option value="lazy">Lazy</option>
                                <option value="none">None</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Hydration Max Chars</label>
                            <input type="number" name="HYDRATION_MAX_CHARS" value="2000">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Vendor Mode</label>
                            <select name="VENDOR_MODE">
                                <option value="prefer_first_party">Prefer First Party</option>
                                <option value="prefer_vendor">Prefer Vendor</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>agro Path Boosts (CSV)</label>
                            <input type="text" name="agro_PATH_BOOSTS" placeholder="app/,lib/,config/">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Cards Max</label>
                            <input type="number" name="CARDS_MAX" value="0" min="0">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Confidence -->
            <div id="tab-confidence" class="tab-content">
                <div class="settings-section">
                    <h3>Confidence Gating</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Confidence Top-1 Threshold</label>
                            <input type="number" name="CONF_TOP1" value="0.62" step="0.01" min="0" max="1">
                        </div>
                        <div class="input-group">
                            <label>Confidence Avg-5 Threshold</label>
                            <input type="number" name="CONF_AVG5" value="0.55" step="0.01" min="0" max="1">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Confidence Any Threshold</label>
                            <input type="number" name="CONF_ANY" value="0.55" step="0.01" min="0" max="1">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Infrastructure -->
            <div id="tab-infra" class="tab-content">
                <div class="settings-section">
                    <h3>Infrastructure</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Qdrant URL</label>
                            <input type="text" name="QDRANT_URL" value="http://127.0.0.1:6333">
                        </div>
                        <div class="input-group">
                            <label>Redis URL</label>
                            <input type="text" name="REDIS_URL" value="redis://127.0.0.1:6379/0">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Active Repository</label>
                            <select name="REPO" id="repo-select"></select>
                        </div>
                        <div class="input-group">
                            <label>Collection Suffix</label>
                            <input type="text" name="COLLECTION_SUFFIX" placeholder="default">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Collection Name</label>
                            <input type="text" name="COLLECTION_NAME" placeholder="code_chunks_{REPO}">
                        </div>
                        <div class="input-group">
                            <label>Repo Path (fallback)</label>
                            <input type="text" name="REPO_PATH" placeholder="/path/to/repo">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Repos File</label>
                            <input type="text" name="REPOS_FILE" value="./repos.json">
                        </div>
                        <div class="input-group">
                            <label>Out Dir Base</label>
                            <input type="text" name="OUT_DIR_BASE" placeholder="./out.noindex or ./out">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>RAG Out Base</label>
                            <input type="text" name="RAG_OUT_BASE" placeholder="Override for OUT_DIR_BASE">
                        </div>
                        <div class="input-group">
                            <label>MCP HTTP Host</label>
                            <input type="text" name="MCP_HTTP_HOST" value="0.0.0.0">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>MCP HTTP Port</label>
                            <input type="number" name="MCP_HTTP_PORT" value="8013">
                        </div>
                        <div class="input-group">
                            <label>MCP HTTP Path</label>
                            <input type="text" name="MCP_HTTP_PATH" value="/mcp">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Repositories -->
            <div id="tab-repos" class="tab-content">
                <div class="settings-section">
                    <h3>Repository Configuration</h3>
                    <div id="repos-section"></div>
                </div>
            </div>

            <!-- Tab: Indexing -->
            <div id="tab-indexing" class="tab-content">
                <div class="settings-section">
                    <h3>Indexing Configuration</h3>
                    <p class="mono" style="color: #888; margin-bottom: 16px;">
                        Most indexing settings are constants in code. Rebuild indices after changing repository paths or sources.
                    </p>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Run Indexer for Repo</label>
                            <button class="small-button" id="btn-index-start">Index Server</button>
                        </div>
                        <div class="input-group">
                            <label>Cards</label>
                            <div style="display:flex; gap:8px;">
                                <button class="small-button" id="btn-cards-build">Build Cards</button>
                                <button class="small-button" id="btn-cards-refresh">Refresh</button>
                            </div>
                        </div>
                    </div>
                    <div id="index-status" class="result-display" style="min-height: 80px;"></div>
                    <div class="progress" style="margin-top:12px; background:#111; border:1px solid #2a2a2a; border-radius:4px; height:12px;">
                        <div id="index-bar" style="height:100%; width:0%; background:#ff9b5e; transition: width 0.3s ease;"></div>
                    </div>
                </div>
            </div>

            <!-- Tab: Evaluation -->
            <div id="tab-eval" class="tab-content">
                <div class="settings-section">
                    <h3>Evaluation Configuration</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Golden Questions Path</label>
                            <input type="text" name="GOLDEN_PATH" value="golden.json">
                        </div>
                        <div class="input-group">
                            <label>Baseline Path</label>
                            <input type="text" name="BASELINE_PATH" value="eval_baseline.json">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Eval Multi-Query</label>
                            <select name="EVAL_MULTI">
                                <option value="1">Yes</option>
                                <option value="0">No</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Eval Final K</label>
                            <input type="number" name="EVAL_FINAL_K" value="5">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Misc -->
            <div id="tab-misc" class="tab-content">
                <div class="settings-section">
                    <h3>Miscellaneous</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Edition (AGRO_EDITION)</label>
                            <input type="text" name="AGRO_EDITION" placeholder="oss | pro | enterprise">
                        </div>
                        <div class="input-group">
                            <label>Thread ID</label>
                            <input type="text" name="THREAD_ID" placeholder="http or cli-chat">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Serve Port</label>
                            <input type="number" name="PORT" value="8012">
                        </div>
                        <div class="input-group">
                            <label>agro Path</label>
                            <input type="text" name="agro_PATH">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>LangChain Tracing V2</label>
                            <select name="LANGCHAIN_TRACING_V2">
                                <option value="0">Off</option>
                                <option value="1">On</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>LangChain agro</label>
                            <input type="text" name="LANGCHAIN_agro">
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Netlify API Key</label>
                            <input type="password" name="NETLIFY_API_KEY">
                        </div>
                        <div class="input-group">
                            <label>Netlify Domains</label>
                            <input type="text" name="NETLIFY_DOMAINS">
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-buttons" style="padding: 0 24px 24px;">
                <button id="save-btn">Apply All Changes</button>
            </div>
        </div>

        <!-- Right Sidepanel -->
        <div class="sidepanel">
            <!-- Cost Calculator -->
            <div class="sidepanel-section">
                <h4>Live Cost Calculator
                    <span style="margin-left:8px;display:inline-flex;align-items:center;gap:6px;font-size:10px;color:#00ff88;font-weight:500;text-transform:uppercase;letter-spacing:0.5px;">
                        <span style="width:6px;height:6px;border-radius:50%;background:#00ff88;animation:blink 2s ease-in-out infinite;"></span>
                        LIVE
                    </span>
                </h4>
                <div class="input-group" style="margin-bottom: 12px;">
                    <label>Inference Provider</label>
                    <select id="cost-provider">
                        <option value="openai">openai</option>
                        <option value="anthropic">anthropic</option>
                        <option value="google">google</option>
                        <option value="mistral">mistral</option>
                        <option value="cohere">cohere</option>
                        <option value="local">local</option>
                    </select>
                </div>
                <div class="input-group" style="margin-bottom: 12px;">
                    <label>Inference Model</label>
                    <input type="text" id="cost-model" list="model-list" value="gpt-4o-mini">
                    <datalist id="model-list"></datalist>
                </div>
                <div class="input-row" style="margin-bottom: 12px;">
                    <div class="input-group">
                        <label>Embeddings Provider</label>
                        <select id="cost-embed-provider">
                            <option value="">Use current</option>
                            <option value="openai">OpenAI</option>
                            <option value="voyage">Voyage</option>
                            <option value="mxbai">MXBAI</option>
                            <option value="local">Local</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Embedding Model</label>
                        <input type="text" id="cost-embed-model" list="embed-model-list" placeholder="text-embedding-3-small">
                        <datalist id="embed-model-list"></datalist>
                    </div>
                </div>
                <div class="input-row" style="margin-bottom: 12px;">
                    <div class="input-group">
                        <label>Reranker</label>
                        <select id="cost-rerank-provider">
                            <option value="">Use current</option>
                            <option value="cohere">Cohere</option>
                            <option value="hf">Hugging Face</option>
                            <option value="local">Local</option>
                            <option value="none">None</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Rerank Model</label>
                        <input type="text" id="cost-rerank-model" list="rerank-model-list" placeholder="rerank-3.5 or BAAI/bge-reranker-v2-m3">
                    </div>
                </div>
                <div class="input-row" style="margin-bottom: 12px;">
                    <div class="input-group">
                        <label>Tokens In</label>
                        <input type="number" id="cost-in" value="500">
                    </div>
                    <div class="input-group">
                        <label>Tokens Out</label>
                        <input type="number" id="cost-out" value="800">
                    </div>
                </div>
                <div class="input-row" style="margin-bottom: 12px;">
                    <div class="input-group">
                        <label>Embeds</label>
                        <input type="number" id="cost-embeds" value="0">
                    </div>
                    <div class="input-group">
                        <label>Reranks</label>
                        <input type="number" id="cost-rerank" value="0">
                    </div>
                </div>
                <div class="input-group" style="margin-bottom: 12px;">
                    <label>Requests / Day</label>
                    <input type="number" id="cost-rpd" value="100">
                </div>
                <button class="small-button" id="btn-estimate">Calculate Cost</button>
                <button class="small-button" id="btn-add-cost-model" style="margin-left:8px;">Add Model</button>
                <div class="cost-results">
                    <div class="result-item">
                        <span class="result-label">Daily</span>
                        <span class="result-value" id="cost-daily">—</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Monthly</span>
                        <span class="result-value" id="cost-monthly">—</span>
                    </div>
                </div>
            </div>

            <!-- Profiles (saved list only) -->
            <div class="sidepanel-section">
                <h4>Profiles</h4>
                <div class="input-group" style="margin: 10px 0;">
                    <label>Save Current As</label>
                    <input type="text" id="profile-name" placeholder="my-config">
                </div>
                <button class="small-button" id="btn-save-profile">Save Profile</button>
                <div style="margin-top: 10px;">
                    <label style="margin-bottom: 6px; display: block;">Saved Profiles</label>
                    <ul id="profiles-ul" class="mono" style="list-style: none; padding: 0;"></ul>
                </div>
            </div>

            <!-- Auto-Tune (Pro) -->
            <div class="sidepanel-section">
                <h4>Auto‑Tune</h4>
                <div class="input-row" style="margin-bottom: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="autotune-enabled" style="width: auto;"> Enable Auto‑Tune
                    </label>
                </div>
                <div class="input-row" style="margin-bottom: 8px;">
                    <div>Current Mode: <span id="autotune-mode">—</span></div>
                </div>
                <button class="small-button" id="btn-autotune-refresh">Refresh Status</button>
            </div>

            <!-- Secrets Ingest -->
            <div class="sidepanel-section">
                <h4>Secrets Ingest</h4>
                <div id="dropzone" class="dropzone">
                    Drop .env / .txt / .md<br>or click to upload
                </div>
                <input type="file" id="file-input" accept=".env,.txt,.md" hidden />
                <div style="margin: 12px 0;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="persist-secrets" style="width: auto;">
                        <span style="text-transform: none;">Persist to defaults.json</span>
                    </label>
                </div>
                <pre id="ingest-out" class="mono" style="margin-top: 12px; padding: 8px; background: #0a0a0a; border-radius: 4px; max-height: 150px; overflow: auto;"></pre>
            </div>
        </div>
    </div>

    <datalist id="keywords-list"></datalist>
    <script src="/gui/app.js"></script>
</body>
</html>
            <!-- Tab: Cards -->
            <div id="tab-cards" class="tab-content">
                <div class="settings-section">
                    <h3>Cards</h3>
                    <div id="cards-list" class="mono" style="background:#0a0a0a;border:1px solid #2a2a2a;border-radius:6px; padding:8px; max-height:320px; overflow:auto;"></div>
                </div>
            </div>
